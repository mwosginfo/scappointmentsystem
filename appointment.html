<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #a4c2f4; font-family: 'Inter', sans-serif; }
    h5 { font-weight: 700; }
    .appt-block, .option-box { background: #fff; border-radius: 14px; padding: 18px; transition: .2s ease; box-shadow: 0 3px 10px rgba(0,0,0,.07); }
    .option-box:hover, .appt-block:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,.12); }
    .option-box.selected { border: 2px solid #28a745 !important; background: #e9f9ed !important; }
    .option-box img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
    .services-subheader { font-size: .85rem; line-height: 1.25; }
    .date-btn { margin-right: 6px; margin-bottom: 4px; }
    .date-btn.active { background-color: #28a745 !important; border-color: #28a745 !important; color: #fff !important; }
    .ticket-wrapper { box-shadow: 0 5px 20px rgba(0,0,0,.15); }
    @media (max-width: 480px) { .ticket-wrapper { transform: scale(.95); transform-origin: top center; } }
    .edit-banner { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .sub-options { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 8px; }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- EDIT REGISTRATION LOOKUP -->
  <div class="card mb-4" id="editLookup">
    <div class="card-body">
      <h5 class="mb-3">Already registered?</h5>
      <div class="d-flex gap-2">
        <input type="email" class="form-control" id="lookupEmail" placeholder="Enter your email to view/edit registration">
        <button class="btn btn-outline-primary" onclick="lookupRegistration()">Lookup</button>
      </div>
      <div id="lookupResult" class="mt-2"></div>
    </div>
  </div>

  <!-- PAGE 1: Agency Selection -->
  <div id="page1">
    <div id="agencyGrid">
      <p class="text-center">Loading agencies...</p>
    </div>
    <button class="btn btn-success mt-4" id="nextBtn" onclick="goToPage2()">Next →</button>
  </div>

  <!-- PAGE 2: Personal Info Form -->
  <div id="page2" class="d-none">
    <div id="editBanner" class="edit-banner d-none">
      <strong>Editing Registration:</strong> <span id="editRef"></span>
      <button class="btn btn-sm btn-outline-secondary ms-2" onclick="cancelEdit()">Cancel Edit</button>
    </div>

    <h3 class="mb-3">Complete your registration</h3>
    <form id="registrationForm">
      <input type="hidden" id="selectedOptions" name="selectedOptions">

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-control" name="lastName" id="fLastName" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">First Name</label>
          <input type="text" class="form-control" name="firstName" id="fFirstName" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Middle Name</label>
          <input type="text" class="form-control" name="middleName" id="fMiddleName">
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email" id="fEmail" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Contact</label>
          <input type="text" class="form-control" name="contact" id="fContact" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Gender</label>
          <select class="form-select" name="gender" id="fGender" required>
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Employer</label>
          <input type="text" class="form-control" name="employer" id="fEmployer">
        </div>
        <div class="col-md-6">
          <label class="form-label">Position</label>
          <input type="text" class="form-control" name="position" id="fPosition">
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" onclick="backToPage1()">← Back</button>
        <button class="btn btn-primary" type="submit" id="submitBtn">Submit</button>
      </div>
    </form>
  </div>

  <!-- QR SECTION -->
  <div id="qrSection" class="d-none text-center mt-4">
    <div class="ticket-wrapper mx-auto" style="max-width:420px;border:2px solid #000;border-radius:12px;background:#fff;">
      <div class="p-3">
        <h4 id="ticketName" class="fw-bold mb-2"></h4>
        <p>Please save or screenshot this QR code.</p>
        <img id="qrCode" style="width:65%;max-width:210px;border:1px solid #ccc;padding:8px;border-radius:8px;" alt="QR Code">
        <p class="mt-3"><strong>Selected Agencies & Appointments:</strong></p>
        <ul id="selectedAgenciesList" style="padding-left:20px;text-align:left;"></ul>
      </div>
    </div>
    <button class="btn btn-outline-primary mt-3" onclick="location.reload()">Register Another</button>
  </div>
</div>

<script>
const GAS_URL = '<?= ScriptApp.getService().getUrl() ?>';

let config = null;
let selectedAgencies = [];
let selectedDates = {};
let selectedTimes = {};
let selectedDateTimes = {};
let editMode = false;
let editData = null;

// ---- INIT ----
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch(GAS_URL + '?action=getConfig');
    config = await res.json();
    buildAgencyGrid();
  } catch (e) {
    document.getElementById('agencyGrid').innerHTML = '<p class="text-danger">Error loading config.</p>';
    console.error(e);
  }
});

// ---- BUILD AGENCY GRID ----
function buildAgencyGrid() {
  const grid = document.getElementById('agencyGrid');
  grid.innerHTML = '';

  const categories = {};
  config.agencies.forEach(a => {
    const cat = a.category || 'other';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(a);
  });

  const catLabels = {
    appointment: 'Scheduled Appointments Required',
    embassy: 'Embassy Transactions',
    other: 'Other Agencies',
    other_multi: 'Other Agencies',
    other_radio: 'Other Agencies'
  };

  // Group 'other', 'other_multi', 'other_radio' together
  const grouped = {};
  for (const [cat, items] of Object.entries(categories)) {
    const label = catLabels[cat] || 'Other';
    if (!grouped[label]) grouped[label] = [];
    grouped[label].push(...items);
  }

  for (const [label, items] of Object.entries(grouped)) {
    const heading = document.createElement('h5');
    heading.className = 'mt-4 mb-3';
    heading.textContent = label;
    grid.appendChild(heading);

    const row = document.createElement('div');
    row.className = 'row g-3';

    items.forEach(agency => {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-3';

      const isAppt = agency.needsAppointment;
      const dates = config.appointmentDates || [];

      let dateButtons = '';
      if (isAppt && dates.length) {
        dateButtons = `<div class="mt-2 date-wrapper d-none" id="dates_${agency.agencyKey}">
          ${dates.map(d => `<button class="btn btn-outline-primary date-btn" data-agency="${agency.agencyKey}" data-date="${d.date}" onclick="selectDate(this)">${d.label || d.date}</button>`).join('')}
        </div>
        <select class="form-select mt-2 time-dropdown d-none" id="time_${agency.agencyKey}" data-agency="${agency.agencyKey}" onchange="selectTime(this)"></select>
        <small class="text-danger" id="msg_${agency.agencyKey}"></small>`;
      }

      const servicesHtml = agency.services.length
        ? `<div class="services-subheader text-muted mt-1"><div>Services:</div>${agency.services.map(s => `<div>${s}</div>`).join('')}</div>`
        : '';

      const logoHtml = agency.logoUrl ? `<img src="${agency.logoUrl}" alt="${agency.agencyName}">` : '';

      // Special handling for multi-select and radio categories
      let subOptionsHtml = '';
      if (agency.category === 'other_multi' && agency.services.length > 1) {
        subOptionsHtml = `<div class="sub-options d-none" id="sub_${agency.agencyKey}">
          ${agency.services.map((s, i) => `<div class="form-check"><input class="form-check-input sub-check" type="checkbox" value="${s}" data-agency="${agency.agencyKey}" id="sub_${agency.agencyKey}_${i}"><label class="form-check-label" for="sub_${agency.agencyKey}_${i}">${s}</label></div>`).join('')}
        </div>`;
      }
      if (agency.category === 'other_radio' && agency.services.length > 1) {
        subOptionsHtml = `<div class="sub-options d-none" id="sub_${agency.agencyKey}">
          ${agency.services.map((s, i) => `<div class="form-check"><input class="form-check-input sub-radio" type="radio" name="radio_${agency.agencyKey}" value="${s}" id="sub_${agency.agencyKey}_${i}"><label class="form-check-label" for="sub_${agency.agencyKey}_${i}">${s}</label></div>`).join('')}
        </div>`;
      }

      col.innerHTML = `
        <div class="appt-block text-center">
          <div class="option-box agency-box" data-agency="${agency.agencyKey}" onclick="toggleAgency(this, '${agency.agencyKey}')">
            ${logoHtml}
            <div><strong>${agency.agencyName}</strong></div>
            ${servicesHtml}
          </div>
          ${dateButtons}
          ${subOptionsHtml}
        </div>`;

      row.appendChild(col);
    });

    grid.appendChild(row);
  }
}

// ---- AGENCY TOGGLE ----
function toggleAgency(box, key) {
  box.classList.toggle('selected');
  const isSelected = box.classList.contains('selected');

  if (isSelected) {
    selectedAgencies.push(key);
    const datesEl = document.getElementById('dates_' + key);
    if (datesEl) datesEl.classList.remove('d-none');
    const subEl = document.getElementById('sub_' + key);
    if (subEl) subEl.classList.remove('d-none');
  } else {
    selectedAgencies = selectedAgencies.filter(a => a !== key);
    delete selectedDates[key];
    delete selectedTimes[key];
    delete selectedDateTimes[key];
    const datesEl = document.getElementById('dates_' + key);
    if (datesEl) datesEl.classList.add('d-none');
    const timeEl = document.getElementById('time_' + key);
    if (timeEl) { timeEl.classList.add('d-none'); timeEl.innerHTML = ''; }
    const subEl = document.getElementById('sub_' + key);
    if (subEl) subEl.classList.add('d-none');
  }
}

// ---- DATE SELECTION ----
function selectDate(btn) {
  const agency = btn.dataset.agency;
  const date = btn.dataset.date;
  selectedDates[agency] = date;

  // Highlight active button
  const parent = btn.closest('.appt-block');
  parent.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // Load time slots
  const dropdown = document.getElementById('time_' + agency);
  const msg = document.getElementById('msg_' + agency);
  dropdown.classList.remove('d-none');
  dropdown.disabled = true;
  dropdown.innerHTML = '<option>Loading...</option>';
  msg.innerText = 'Loading...';

  fetchSlots(agency, date, dropdown, msg);
}

async function fetchSlots(agency, date, dropdown, msg) {
  try {
    const res = await fetch(`${GAS_URL}?action=getSlots&agency=${agency}&date=${date}`);
    const slots = await res.json();
    if (!slots.length) {
      dropdown.innerHTML = '<option>No slots available</option>';
      dropdown.disabled = true;
      msg.innerText = 'No slots available';
      return;
    }
    dropdown.disabled = false;
    msg.innerText = '';
    dropdown.innerHTML = '<option value="">Select time</option>' +
      slots.map(s => `<option value="${s}">${s}</option>`).join('');
  } catch (err) {
    dropdown.innerHTML = '<option>Error loading</option>';
    msg.innerText = 'Error';
    console.error(err);
  }
}

// ---- TIME SELECTION ----
function selectTime(dropdown) {
  const agency = dropdown.dataset.agency;
  const date = selectedDates[agency];
  const time = dropdown.value;
  if (!time) { selectedTimes[agency] = ''; delete selectedDateTimes[agency]; return; }
  selectedTimes[agency] = time;
  selectedDateTimes[agency] = `${date} ${time}`;
}

// ---- PAGE NAVIGATION ----
function goToPage2() {
  if (!selectedAgencies.length) { alert('Please select at least one agency'); return; }

  // Validate appointment agencies
  const apptAgencies = (config.agencies || []).filter(a => a.needsAppointment && a.enabled);
  for (const a of apptAgencies) {
    if (selectedAgencies.includes(a.agencyKey)) {
      if (!selectedDates[a.agencyKey]) { alert(`${a.agencyName}: Please choose a date.`); return; }
      if (!selectedTimes[a.agencyKey]) { alert(`${a.agencyName}: Please choose a time slot.`); return; }
    }
  }

  document.getElementById('selectedOptions').value = selectedAgencies.join(', ');
  document.getElementById('page1').classList.add('d-none');
  document.getElementById('page2').classList.remove('d-none');
  document.getElementById('editLookup').classList.add('d-none');
}

function backToPage1() {
  document.getElementById('page2').classList.add('d-none');
  document.getElementById('page1').classList.remove('d-none');
  document.getElementById('editLookup').classList.remove('d-none');
}

// ---- FORM SUBMISSION ----
document.getElementById('registrationForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerText = 'Submitting...';

  const formData = new FormData(this);

  // Add appointment data
  const apptAgencies = (config.agencies || []).filter(a => a.needsAppointment);
  apptAgencies.forEach(a => {
    if (selectedAgencies.includes(a.agencyKey) && selectedDateTimes[a.agencyKey]) {
      formData.append('appt' + a.agencyKey, selectedDateTimes[a.agencyKey]);
    }
  });

  // Add multi-select sub-options
  document.querySelectorAll('.sub-check:checked').forEach(cb => {
    formData.append(cb.dataset.agency + 'transSelected', cb.value);
  });
  document.querySelectorAll('.sub-radio:checked').forEach(rb => {
    formData.append(rb.name.replace('radio_', '') + 'transSelected', rb.value);
  });

  if (editMode) formData.append('_action', 'updateRegistration');

  try {
    const response = await fetch(GAS_URL, { method: 'POST', body: formData });
    const result = await response.json();

    if (result.error === 'duplicate') {
      alert('This email is already registered (Ref: ' + result.reference + '). Use the lookup to edit.');
      submitBtn.disabled = false;
      submitBtn.innerText = 'Submit';
      return;
    }
    if (result.error) { throw new Error(result.message || 'Unknown error'); }

    // Show QR ticket
    const fullName = `${formData.get('firstName')} ${formData.get('lastName')}`;
    document.getElementById('page2').classList.add('d-none');
    document.getElementById('qrSection').classList.remove('d-none');
    document.getElementById('ticketName').innerText = fullName;
    document.getElementById('qrCode').src = result.qrUrl;

    const ul = document.getElementById('selectedAgenciesList');
    ul.innerHTML = '';
    selectedAgencies.forEach(key => {
      const li = document.createElement('li');
      let text = key;
      if (selectedDateTimes[key]) text += ` (${selectedDateTimes[key]})`;
      li.textContent = text;
      ul.appendChild(li);
    });
  } catch (err) {
    alert('Error: ' + err.message);
    submitBtn.disabled = false;
    submitBtn.innerText = 'Submit';
  }
});

// ---- LOOKUP / EDIT ----
async function lookupRegistration() {
  const email = document.getElementById('lookupEmail').value.trim();
  if (!email) return alert('Enter an email');

  const resultDiv = document.getElementById('lookupResult');
  resultDiv.innerHTML = '<em>Looking up...</em>';

  try {
    const res = await fetch(`${GAS_URL}?action=lookupEmail&email=${encodeURIComponent(email)}`);
    const data = await res.json();

    if (!data.found) {
      resultDiv.innerHTML = '<span class="text-muted">No registration found. You can register below.</span>';
      return;
    }
    if (data.checkedIn) {
      resultDiv.innerHTML = '<span class="text-warning">Already checked in. Cannot edit.</span>';
      return;
    }

    editMode = true;
    editData = data;
    resultDiv.innerHTML = `<span class="text-success">Found! Ref: <strong>${data.reference}</strong> — ${data.fullName}</span>
      <button class="btn btn-sm btn-warning ms-2" onclick="loadEdit()">Edit Registration</button>`;
  } catch (e) {
    resultDiv.innerHTML = '<span class="text-danger">Error looking up.</span>';
  }
}

function loadEdit() {
  if (!editData) return;

  // Pre-fill form
  document.getElementById('fLastName').value = editData.lastName;
  document.getElementById('fFirstName').value = editData.firstName;
  document.getElementById('fMiddleName').value = editData.middleName;
  document.getElementById('fEmail').value = editData.email;
  document.getElementById('fEmail').readOnly = true;
  document.getElementById('fContact').value = editData.contact;
  document.getElementById('fGender').value = editData.gender;
  document.getElementById('fEmployer').value = editData.employer;
  document.getElementById('fPosition').value = editData.position;

  // Set selected agencies from existing data
  if (editData.selectedOptions) {
    editData.selectedOptions.split(',').map(s => s.trim()).forEach(key => {
      const box = document.querySelector(`.agency-box[data-agency="${key}"]`);
      if (box) toggleAgency(box, key);
    });
  }

  document.getElementById('editBanner').classList.remove('d-none');
  document.getElementById('editRef').textContent = editData.reference;
  document.getElementById('selectedOptions').value = editData.selectedOptions;

  document.getElementById('page1').classList.add('d-none');
  document.getElementById('page2').classList.remove('d-none');
  document.getElementById('editLookup').classList.add('d-none');
}

function cancelEdit() {
  editMode = false;
  editData = null;
  location.reload();
}
</script>
</body>
</html>
